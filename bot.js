/* eslint-disable no-console */
require('dotenv').config();
const TelegramBot = require('node-telegram-bot-api');
const { User } = require('./db/models');

const token = process.env.TELEGRAM_TOKEN;
const bot = new TelegramBot(token, { polling: true });

const hello = `‚ú® –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä –∫—Ä–æ—Å—Å–æ–≤–æ–∫ —Å poizon-discount! ‚ú®

–ú—ã ‚Äî –≤–∞—à –Ω–∞–¥–µ–∂–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –≤ –ø–æ–∏—Å–∫–µ –∏–¥–µ–∞–ª—å–Ω—ã—Ö –∫—Ä–æ—Å—Å–æ–≤–æ–∫ –ø–æ –ª—É—á—à–∏–º —Ü–µ–Ω–∞–º! –ù–∞—à –±–æ—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —à–∏—Ä–æ–∫–∏–π –≤—ã–±–æ—Ä –º–æ–¥–µ–ª–µ–π –æ—Ç –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –±—Ä–µ–Ω–¥–æ–≤, –∞–∫—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ —Å–∫–∏–¥–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å. –ü—Ä–æ—Å—Ç–æ —É–∫–∞–∂–∏—Ç–µ –≤–∞—à–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è, –∏ –º—ã –ø–æ–¥–±–µ—Ä–µ–º –¥–ª—è –≤–∞—Å –ª—É—á—à–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã!

üëü –ß—Ç–æ –º—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º?
- –®–∏—Ä–æ–∫–∏–π –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç: –æ—Ç –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏—Ö –º–æ–¥–µ–ª–µ–π –¥–æ –Ω–æ–≤–∏–Ω–æ–∫ —Å–µ–∑–æ–Ω–∞.
- –ê–∫—Ü–∏–∏ –∏ —Å–∫–∏–¥–∫–∏: –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –ª—É—á—à–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ —ç–∫–æ–Ω–æ–º—å—Ç–µ –Ω–∞ –ª—é–±–∏–º—ã—Ö –∫—Ä–æ—Å—Å–æ–≤–∫–∞—Ö.
- –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –≤–∫—É—Å–æ–≤ –∏ —Å—Ç–∏–ª—è.
- –ù–∞–¥–µ–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–ª–∏—á–∏–∏: –ø–æ–ª—É—á–∏—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –≤—ã—Å–≤–µ—á–∏–≤–∞–Ω–∏–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤.

üöÄ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?
1. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "–°–∞–π—Ç" –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∫—Ä–æ—Å—Å–æ–≤–æ–∫.
2. –ü–æ–ª—É—á–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π —Å–æ —Å–∫–∏–¥–∫–∞–º–∏.
3. –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à—É—é—Å—è –ø–∞—Ä—É –∏ –æ—Ñ–æ—Ä–º–∏—Ç–µ –∑–∞–∫–∞–∑ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª–∏–∫–æ–≤!

üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 24/7: —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã? –ù–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞ –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤–∞ –ø–æ–º–æ—á—å –≤–∞–º –≤—ã–±—Ä–∞—Ç—å –∏–¥–µ–∞–ª—å–Ω—ã–µ –∫—Ä–æ—Å—Å–æ–≤–∫–∏!

–ü—Ä–æ–±—É–π—Ç–µ poizon-discount ‚Äì –º—ã —Å–¥–µ–ª–∞–µ–º —à–æ–ø–∏–Ω–≥ –ø—Ä–∏—è—Ç–Ω—ã–º, –ø—Ä–æ—Å—Ç—ã–º –∏ –≤—ã–≥–æ–¥–Ω—ã–º! üåü`;

const textSupport = `üí¨–ß–∞—Ç @kornov112
(–û—Ç–∑—ã–≤—ã –∏ –æ–±—â–µ–Ω–∏–µ)

üë®‚Äçüíª–ê–¥–º–∏–Ω @kornov112
(–í–æ–ø—Ä–æ—Å—ã –ø–æ –∑–∞–∫–∞–∑—É )

üëë –ì–õ–ê–í–ù–´–ô @kornov112
(C–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ, –∂–∞–ª–æ–±—ã –Ω–∞ @poison_discount_bot)`;

const channelText  = `
–ü–û–î–ü–ò–°–´–í–ê–ô–°–Ø –ù–ê –ö–ê–ù–ê–õ 
üëâ  https://t.me/discountPoizon

–í—Å–µ–≥–¥–∞ –±—É–¥–µ—à—å –≤ –∫—É—Ä—Å–µ
üî•–ù–û–í–ò–ù–ö–ò –ò –ê–ö–¶–ò–òüî•
‚ú®–ö–£–ü–û–ù–´ –ò –°–ö–ò–î–ö–ò‚ú®

–í–°–ï–ì–î–ê –î–ï–ô–°–¢–í–£–ï–¢
üí•–†–û–ó–´–ì–†–´–®üí•
–î–ª—è —É—á–∞—Å—Ç–∏—è –Ω–∞–¥–æ –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–∞—Ç—å –Ω–∞ –∫–Ω–æ–ø–∫—É üî¥`

const webAppUrl = 'https://poizon-discount.ru/';

let isProcessing = false;

bot.on('message', async (msg) => {
  if (isProcessing) return;
  isProcessing = true;

  const chatId = msg.chat.id;
  const { text } = msg;

  if (text === '/start') {
    const userName = msg.from.username || msg.from.first_name;

    try {
      let userInstance = await User.findOne({ where: { name: userName } });

      if (!userInstance) {
        userInstance = await User.create({ name: userName, chatid: chatId });
      } else {
        await User.update(
          { chatid: chatId },
          {
            where: {
              name: userInstance.name,
            },
          },
        );
      }

      await bot.sendMessage(chatId, hello, {
        reply_markup: {
          keyboard: [
            [{ text: 'üëü –í –º–∞–≥–∞–∑–∏–Ω üëü', web_app: { url: webAppUrl } }],
            [{ text: '‚ùì FAQ ‚ùì' }],
            [{ text: 'üë®‚Äçüíª –ü–æ–¥–¥–µ—Ä–∂–∫–∞ üë®‚Äçüíª' }],
            [{ text: 'üë®‚Äçüë©‚Äçüë¶‚Äçüë¶ –ö–∞–Ω–∞–ª üë®‚Äçüë©‚Äçüë¶‚Äçüë¶' }],
          ],
          resize_keyboard: true,
          one_time_keyboard: true,
        },
      });
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º:', error);
      await bot.sendMessage(chatId, '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ –ø–æ–∑–∂–µ.');
    }
  } else if (text === '‚ùì FAQ ‚ùì') {
    await bot.sendMessage(chatId, '–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö –ø—É–Ω–∫—Ç–æ–≤:', {
      reply_markup: {
        inline_keyboard: [
          [
            { text: '–ß—Ç–æ —Ç–∞–∫–æ–µ Poizon-Discount?', callback_data: 'faq_1' },
            { text: '–ê–¥—Ä–µ—Å —Å–∞–º–æ–≤—ã–≤–æ–∑–∞?', callback_data: 'faq_2' },
          ],
          [
            { text: '–ö–∞–∫ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π?', callback_data: 'faq_3' },
          ],
        ],
      },
    });
  } else if (text === 'üë®‚Äçüíª –ü–æ–¥–¥–µ—Ä–∂–∫–∞ üë®‚Äçüíª') {
    await bot.sendMessage(chatId, textSupport);
  } else if (text === 'üë®‚Äçüë©‚Äçüë¶‚Äçüë¶ –ö–∞–Ω–∞–ª üë®‚Äçüë©‚Äçüë¶‚Äçüë¶') {
    await bot.sendMessage(chatId, channelText);
  }
  isProcessing = false;
});

bot.on('callback_query', async (callbackQuery) => {
  const chatId = callbackQuery.message.chat.id;
  const query = callbackQuery.data;

  switch (query) {
    case 'faq_1':
      await bot.sendMessage(chatId, 'Poizon-Discount - —ç—Ç–æ –æ–Ω–ª–∞–π–Ω-–º–∞–≥–∞–∑–∏–Ω, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –ø—Ä–æ–¥–∞–∂–µ –∫—Ä–æ—Å—Å–æ–≤–æ–∫ —Å –ø–æ–ø—É–ª—è—Ä–Ω–æ–π –ø–ª–æ—â–∞–¥–∫–∏ Poizon!');
      break;
    case 'faq_2':
      await bot.sendMessage(chatId, '–ê–¥—Ä–µ—Å —Å–∞–º–æ–≤—ã–≤–æ–∑–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ –∞–¥—Ä–µ—Å—É: –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É–≥, –õ–∏–≥–æ–≤—Å–∫–∏–π –ø—Ä—Å–æ–ø–µ–∫—Ç 55');
      break;
    case 'faq_3':
      await bot.sendMessage(chatId, textSupport);
      break;
    default:
      await bot.sendMessage(chatId, '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å!');
  }

  await bot.answerCallbackQuery(callbackQuery.id);
});

module.exports = bot;
